<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockPro Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: '#6366f1', // Indigo
                        brandHover: '#4f46e5',
                        dark: '#050505',
                        surface: '#121215',
                        border: '#27272a'
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.6s ease-out forwards',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #000000; 
            color: #e4e4e7; 
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scroll bars for aesthetics */
        }

        /* Glassmorphism Panel */
        .glass-panel {
            background: rgba(18, 18, 21, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Custom Drag & Drop Zone */
        .upload-zone {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%233F3F46FF' stroke-width='2' stroke-dasharray='10%2c 10' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .upload-zone:hover, .upload-zone.active {
            background-color: rgba(99, 102, 241, 0.05);
            border-color: #6366f1;
            transform: scale-[1.01];
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%236366F1FF' stroke-width='2' stroke-dasharray='10%2c 10' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }

        /* Apple-style Toggle Switch */
        .toggle-checkbox { display: none; }
        .toggle-label {
            width: 50px; height: 28px;
            background: #27272a;
            border-radius: 999px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .toggle-label::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px;
            width: 24px; height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .toggle-checkbox:checked + .toggle-label {
            background: #6366f1; /* Brand Color */
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.4);
        }
        .toggle-checkbox:checked + .toggle-label::after {
            transform: translateX(22px);
        }

        /* Loading Spinner */
        .loader {
            border: 2px solid rgba(255,255,255,0.1);
            border-left-color: #ffffff;
            border-radius: 50%; width: 18px; height: 18px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Input Fields Focus */
        input:focus {
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
            border-color: #6366f1;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-[#1a1a2e] via-[#000000] to-[#000000]">

    <div class="fixed top-[-10%] left-[20%] w-[500px] h-[500px] bg-brand/10 blur-[120px] rounded-full animate-pulse-slow pointer-events-none"></div>
    <div class="fixed bottom-[-10%] right-[10%] w-[400px] h-[400px] bg-purple-900/10 blur-[100px] rounded-full pointer-events-none"></div>

    <div class="glass-panel w-full max-w-lg rounded-3xl p-8 relative z-10 animate-fade-in-up">
        
        <div class="text-center mb-10">
            <div class="inline-flex items-center justify-center w-14 h-14 rounded-2xl bg-gradient-to-br from-brand/20 to-transparent border border-white/5 mb-4 shadow-lg shadow-brand/10">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-white tracking-tight">StockPro<span class="text-brand">.ai</span></h1>
            <p class="text-zinc-500 text-sm mt-2 font-medium">Intelligent Excel Processing</p>
        </div>

        <div class="space-y-6">
            
            <div class="group">
                <label class="block text-[11px] font-bold text-zinc-500 mb-2 uppercase tracking-widest pl-1">Client Identity</label>
                <div class="relative">
                    <input type="text" id="clientName" placeholder="ENTER CLIENT NAME..." 
                        class="w-full bg-surface/50 border border-zinc-800 text-white text-sm font-semibold rounded-xl focus:bg-surface block p-4 outline-none transition-all placeholder-zinc-700 uppercase tracking-wide">
                    <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none">
                        <svg class="w-4 h-4 text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-[11px] font-bold text-zinc-500 mb-2 uppercase tracking-widest pl-1">Data Source</label>
                <div class="upload-zone flex flex-col items-center justify-center w-full h-36 rounded-2xl cursor-pointer relative overflow-hidden group" id="dropZone">
                    <div class="flex flex-col items-center justify-center z-10">
                        <div class="w-10 h-10 mb-3 rounded-full bg-zinc-900 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                            <svg class="w-5 h-5 text-zinc-400 group-hover:text-brand transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        </div>
                        <p class="text-sm text-zinc-300 font-medium">Click to Upload Excel</p>
                        <p class="text-xs text-zinc-600 mt-1" id="fileNameDisplay">or drag and drop file here</p>
                    </div>
                    <input id="fileInput" type="file" class="hidden" accept=".xlsx, .xls" />
                </div>
            </div>

            <div class="flex items-center justify-between bg-zinc-900/50 p-4 rounded-xl border border-zinc-800/50 backdrop-blur-sm">
                <div class="flex flex-col">
                    <span class="text-sm font-semibold text-zinc-200">Merge Faces</span>
                    <span class="text-[10px] text-zinc-500">Combine -A, -B variants into one</span>
                </div>
                <div>
                    <input type="checkbox" id="mergeFaces" class="toggle-checkbox" />
                    <label for="mergeFaces" class="toggle-label"></label>
                </div>
            </div>

            <button onclick="processExcel()" class="relative w-full group overflow-hidden bg-brand hover:bg-brandHover text-white font-semibold rounded-xl text-sm px-6 py-4 transition-all duration-300 shadow-[0_0_30px_-10px_#6366f1] hover:shadow-[0_0_40px_-10px_#6366f1] hover:-translate-y-0.5">
                <div class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]"></div>
                <div class="flex justify-center items-center gap-2 relative z-10">
                    <span id="btnText">Generate Report</span>
                    <div id="loadingSpinner" class="loader hidden"></div>
                </div>
            </button>
            
            <div id="statusMessage" class="text-center text-xs font-medium text-zinc-500 min-h-[20px] transition-colors duration-300"></div>
        </div>

        <div class="mt-8 text-center">
            <p class="text-[10px] text-zinc-700 font-medium tracking-wide">DESIGNED BY PRO â€¢ POWERED BY GEMINI</p>
        </div>
    </div>

    <script>
        // --- UI INTERACTIONS ---

        // Auto Uppercase for Client Name
        const clientInput = document.getElementById('clientName');
        clientInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });

        // Drag & Drop Logic
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        dropZone.addEventListener('click', () => fileInput.click());

        // Visual Feedback for Dragging
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('active');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('active');
            }, false);
        });

        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        });

        fileInput.addEventListener('change', () => handleFiles(fileInput.files));

        function handleFiles(files) {
            if (files.length > 0) {
                fileInput.files = files; // Sync if dropped
                fileNameDisplay.innerText = files[0].name;
                fileNameDisplay.classList.add('text-brand');
                fileNameDisplay.classList.remove('text-zinc-600');
            }
        }

        // --- CORE LOGIC (v3 - The Accurate One) ---
        
        function processExcel() {
            const file = fileInput.files[0];
            const status = document.getElementById('statusMessage');
            const btnText = document.getElementById('btnText');
            const spinner = document.getElementById('loadingSpinner');
            const clientName = document.getElementById('clientName').value.trim();
            const shouldMergeFaces = document.getElementById('mergeFaces').checked;

            if (!file) {
                status.innerText = "Please select an Excel file first.";
                status.classList.add('text-red-400');
                shakeButton();
                return;
            }

            // Processing State
            status.innerText = "";
            btnText.innerText = "Processing...";
            spinner.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                setTimeout(() => { // Tiny delay for UI to breathe
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, defval: ""});

                        // 1. Header Detection
                        let headerIdx = -1, col = { design: -1, cat: -1, size: -1, body: -1, qty: -1 };
                        for (let i = 0; i < Math.min(rawData.length, 25); i++) {
                            const r = rawData[i].map(x => String(x).toLowerCase().trim());
                            if (r.includes('designname') || r.includes('size mm')) {
                                headerIdx = i;
                                col.design = r.indexOf('designname');
                                col.cat = r.indexOf('category');
                                col.size = r.indexOf('size mm');
                                col.body = r.indexOf('bodytype');
                                col.qty = r.findIndex(c => c === 'pre' || c === 'total' || c === 'qty');
                                break;
                            }
                        }

                        if (headerIdx === -1) throw new Error("Could not find standard headers.");

                        // 2. Data Extraction
                        const map = new Map();
                        for (let i = headerIdx + 1; i < rawData.length; i++) {
                            const r = rawData[i];
                            if (!r || r.length === 0) continue;

                            let design = (r[col.design] || "").toString().trim();
                            let size = (r[col.size] || "").toString().trim();
                            let cat = col.cat > -1 ? (r[col.cat] || "").toString().trim() : "";
                            let body = col.body > -1 ? (r[col.body] || "").toString().trim() : "";
                            let qty = col.qty > -1 ? parseFloat(r[col.qty]) : 0;

                            if (!design && !size) continue;
                            if (shouldMergeFaces) design = design.replace(/-[a-zA-Z]$/, "").trim();

                            const key = `${size}_${cat}_${body}_${design}`;
                            if (map.has(key)) map.get(key).qty += qty;
                            else map.set(key, { size, cat, body, design, qty });
                        }

                        let list = Array.from(map.values());

                        // 3. Sorting (Width x Height)
                        function getDims(s) {
                            const m = s.match(/(\d+)/g);
                            if (!m) return { w: 0, h: 0 };
                            return { w: parseInt(m[0] || 0), h: parseInt(m[1] || 0) };
                        }

                        list.sort((a, b) => {
                            const dA = getDims(a.size), dB = getDims(b.size);
                            if (dA.w !== dB.w) return dA.w - dB.w;
                            if (dA.h !== dB.h) return dA.h - dB.h;
                            if (a.cat < b.cat) return -1; if (a.cat > b.cat) return 1;
                            return a.design.localeCompare(b.design);
                        });

                        // 4. Excel Generation
                        const output = [];
                        const sHead = { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "4338CA" } }, alignment: { horizontal: "center", vertical: "center" }, border: { top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} } };
                        const sCell = { alignment: { horizontal: "center", vertical: "center" }, border: { top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} } };
                        const sGrey = { fill: { fgColor: { rgb: "F3F4F6" } }, alignment: { horizontal: "center", vertical: "center" }, border: { top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} } };
                        const sTotal = { font: { bold: true }, fill: { fgColor: { rgb: "E5E7EB" } }, alignment: { horizontal: "center" }, border: { top:{style:"double"} } };
                        const sTitle = { font: { bold: true, sz: 16 }, alignment: { horizontal: "center", vertical: "center" } };

                        // Spacer
                        output.push(["", "", "", "", "", ""]);
                        output.push(["", "", "", "", "", ""]);
                        output.push(["", "", "", "", "", ""]);

                        // Headers
                        output.push(["SR NO", "Size & thikness", "surface", "BodyType", "DesignName", "Total QTY"].map(h => ({ v: h, s: sHead })));

                        let sr = 1, grandTotal = 0, lastSize = null;
                        list.forEach(item => {
                            if (lastSize && lastSize !== item.size) {
                                output.push(new Array(6).fill({v:"",s:sCell}));
                            }
                            lastSize = item.size;
                            grandTotal += item.qty;
                            const style = (sr % 2 === 0) ? sGrey : sCell;
                            output.push([
                                {v:sr++, s:style}, {v:item.size, s:style}, {v:item.cat, s:style},
                                {v:item.body, s:style}, {v:item.design, s:style}, {v:item.qty, s:style}
                            ]);
                        });

                        // Grand Total
                        output.push([{v:"", s:sTotal}, {v:"", s:sTotal}, {v:"", s:sTotal}, {v:"", s:sTotal}, {v:"GRAND TOTAL", s:sTotal}, {v:grandTotal, s:sTotal}]);

                        const newWs = XLSX.utils.aoa_to_sheet(output);
                        if(!newWs['!merges']) newWs['!merges'] = [];
                        newWs['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 2, c: 5 } });
                        newWs['A1'] = { v: clientName || "STOCK REPORT", s: sTitle };
                        newWs['!cols'] = [{wch:8}, {wch:22}, {wch:15}, {wch:15}, {wch:35}, {wch:12}];

                        const newWb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(newWb, newWs, "Stock");
                        XLSX.writeFile(newWb, `Stock_${(clientName||"Report").replace(/\s+/g,'_')}.xlsx`);

                        status.innerText = "Success! File Downloaded.";
                        status.classList.remove('text-red-400');
                        status.classList.add('text-brand');

                    } catch (err) {
                        console.error(err);
                        status.innerText = "Error: " + err.message;
                        status.classList.add('text-red-400');
                    } finally {
                        btnText.innerText = "Generate Report";
                        spinner.classList.add('hidden');
                    }
                }, 800); // Artificial delay for "Processing" feel
            };
            reader.readAsArrayBuffer(file);
        }

        function shakeButton() {
            const btn = document.querySelector('button');
            btn.classList.add('translate-x-1');
            setTimeout(() => btn.classList.remove('translate-x-1'), 100);
            setTimeout(() => btn.classList.add('-translate-x-1'), 200);
            setTimeout(() => btn.classList.remove('-translate-x-1'), 300);
        }
    </script>
</body>
</html>
